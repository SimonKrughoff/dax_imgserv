
minikube start --driver=virtualbox
minikube ssh
cd <location of Dockerfile>
docker build --tag imgserv:with_soda .
minikube mount /Users/krughoff/projects/minikube/datasets/:/datasets
minikube mount /Users/krughoff/projects/minikube/project/:/project
cd Downloads
git clone https://github.com/lsst/dax_imgserv 
cd dax_imgserv/
cd kube
cp -r  stable localhost
cd localhost/
export DAX_NAMESPACE='lsst-lsp-localhost-dax'
vi namespace-localhost.json
kubectl apply -f namespace-localhost.json
kubectl apply -f dax-imgserv-datasets-volume.yaml
kubectl apply -f dax-imgserv-datasets-claim.yaml --namespace $DAX_NAMESPACE
kubectl apply -f dax-imgserv-project-volume.yaml
kubectl apply -f dax-imgserv-project-claim.yaml --namespace $DAX_NAMESPACE
kubectl create secret generic dax-imgserv-config --from-file=/Users/krughoff/projects/minikube/webserv.ini --namespace $DAX_NAMESPACE
kubectl create secret generic dax-db-auth --from-file=/Users/krughoff/projects/minikube/db-auth.yaml --namespace $DAX_NAMESPACE
kubectl apply -f dax-imgserv-deployment.yaml --namespace $DAX_NAMESPACE
kubectl apply -f dax-imgserv-service.yaml --namespace $DAX_NAMESPACE
#kubectl apply -f dax-imgserv-ingress.yaml --namespace $DAX_NAMESPACE
kubectl expose deployment dax-imgserv-deployment --type=NodePort --port=5000 --namespace $DAX_NAMESPACE
kubectl port-forward service/dax-imgserv-deployment 5000:5000 --namespace $DAX_NAMESPACE


source /opt/software/stack/loadLSST.bash
setup lsst_distrib
pipetask run -j 1 -b /project/validation_hsc_gen3/ --register-dataset-types -t lsst.pipe.tasks.calexpCutout.CalexpCutoutTask -d visit=903332 AND detector=20 AND instrument='HSC' --output imgserv_1611792333.547198 -i shared/valid_hsc_all,imgserv_positions_1611792333.547198
